<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="kr.or.kosa.backend.codeboard.mapper.CodeboardMapper">

    <!-- 게시글 목록 조회 -->
    <select id="findPosts" resultType="kr.or.kosa.backend.codeboard.dto.CodeboardListResponseDto">
        SELECT
        C.CODEBOARD_ID AS codeboardId,
        C.USER_ID AS userId,
        U.USER_NICKNAME AS userNickname,
        C.ANALYSIS_ID AS analysisId,
        C.CODEBOARD_TITLE AS codeboardTitle,
        SUBSTRING(C.CODEBOARD_PLAIN_TEXT, 1, 200) AS codeboardSummary,
        C.CODEBOARD_CLICK AS codeboardClick,
        C.CODEBOARD_CREATED_AT AS codeboardCreatedAt,
        (SELECT COUNT(*)
        FROM `LIKE`
        WHERE REFERENCE_ID = C.CODEBOARD_ID
        AND REFERENCE_TYPE = 'POST_CODEBOARD') AS likeCount,
        (SELECT COUNT(*)
        FROM COMMENT
        WHERE BOARD_ID = C.CODEBOARD_ID
        AND BOARD_TYPE = 'CODEBOARD'
        AND IS_DELETED = 0) AS commentCount
        FROM CODEBOARD C
        INNER JOIN USERS U ON C.USER_ID = U.USER_ID
        WHERE C.CODEBOARD_DELETED_YN = 'N'
        <if test="search.keyword != null and search.keyword != ''">
            AND (
            C.CODEBOARD_TITLE LIKE CONCAT('%', #{search.keyword}, '%')
            OR C.CODEBOARD_PLAIN_TEXT LIKE CONCAT('%', #{search.keyword}, '%')
            )
        </if>
        ORDER BY
        <choose>
            <when test="sort.column == 'like_count'">
                likeCount ${sort.directionSql}
            </when>
            <when test="sort.column == 'comment_count'">
                commentCount ${sort.directionSql}
            </when>
            <when test="sort.column == 'view_count'">
                C.CODEBOARD_CLICK ${sort.directionSql}
            </when>
            <otherwise>
                C.CODEBOARD_CREATED_AT ${sort.directionSql}
            </otherwise>
        </choose>
        LIMIT #{page.size} OFFSET #{page.offset}
    </select>

    <!-- 게시글 등록 -->
    <insert id="insert" parameterType="kr.or.kosa.backend.codeboard.domain.Codeboard"
            useGeneratedKeys="true" keyProperty="codeboardId">
        INSERT INTO CODEBOARD (
        USER_ID,
        ANALYSIS_ID,
        CODEBOARD_TITLE,
        CODEBOARD_BLOCKS,
        CODEBOARD_PLAIN_TEXT,
        CODEBOARD_CLICK,
        CODEBOARD_CREATED_AT,
        CODEBOARD_DELETED_YN
        ) VALUES (
        #{userId},
        #{analysisId},
        #{codeboardTitle},
        #{codeboardBlocks},
        #{codeboardPlainText},
        0,
        NOW(),
        #{codeboardDeletedYn}
        )
    </insert>

    <!-- 게시글 수정 -->
    <update id="update" parameterType="kr.or.kosa.backend.codeboard.domain.Codeboard">
        UPDATE CODEBOARD
        SET ANALYSIS_ID = #{analysisId},
        CODEBOARD_TITLE = #{codeboardTitle},
        CODEBOARD_BLOCKS = #{codeboardBlocks},
        CODEBOARD_PLAIN_TEXT = #{codeboardPlainText}
        WHERE CODEBOARD_ID = #{codeboardId}
        AND CODEBOARD_DELETED_YN = 'N'
    </update>

    <!-- 게시글 삭제 (소프트 삭제) -->
    <update id="delete">
        UPDATE CODEBOARD
        SET CODEBOARD_DELETED_YN = 'Y'
        WHERE CODEBOARD_ID = #{codeboardId}
    </update>

    <!-- 게시글 상세 조회 -->
    <select id="selectById" resultType="kr.or.kosa.backend.codeboard.dto.CodeboardDetailResponseDto">
        SELECT
        C.CODEBOARD_ID AS codeboardId,
        C.USER_ID AS userId,
        U.USER_NICKNAME AS userNickname,
        C.ANALYSIS_ID AS analysisId,
        C.CODEBOARD_TITLE AS codeboardTitle,
        C.CODEBOARD_BLOCKS AS codeboardContent,
        C.CODEBOARD_CLICK AS codeboardClick,
        (SELECT COUNT(*)
        FROM `LIKE` L
        WHERE L.REFERENCE_ID = C.CODEBOARD_ID
        AND L.REFERENCE_TYPE = 'POST_CODEBOARD') AS likeCount,
        C.CODEBOARD_CREATED_AT AS codeboardCreatedAt
        FROM CODEBOARD C
        LEFT JOIN USERS U ON C.USER_ID = U.USER_ID
        WHERE C.CODEBOARD_ID = #{codeboardId}
        AND C.CODEBOARD_DELETED_YN = 'N'
    </select>

    <!-- 조회수 증가 -->
    <update id="increaseClick">
        UPDATE CODEBOARD
        SET CODEBOARD_CLICK = CODEBOARD_CLICK + 1
        WHERE CODEBOARD_ID = #{codeboardId}
        AND CODEBOARD_DELETED_YN = 'N'
    </update>

    <!-- 게시글 총 개수 조회 -->
    <select id="countPosts" resultType="long">
        SELECT COUNT(*)
        FROM CODEBOARD C
        WHERE C.CODEBOARD_DELETED_YN = 'N'
        <if test="search.keyword != null and search.keyword != ''">
            AND (
            C.CODEBOARD_TITLE LIKE CONCAT('%', #{search.keyword}, '%')
            OR C.CODEBOARD_PLAIN_TEXT LIKE CONCAT('%', #{search.keyword}, '%')
            )
        </if>
    </select>

</mapper>