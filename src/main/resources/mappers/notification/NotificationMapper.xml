<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="kr.or.kosa.backend.notification.mapper.NotificationMapper">

    <resultMap id="notificationResultMap" type="kr.or.kosa.backend.notification.domain.Notification">
        <id property="notificationId" column="NOTIFICATION_ID"/>
        <result property="recipientId" column="RECIPIENT_ID"/>
        <result property="senderId" column="SENDER_ID"/>
        <result property="notificationType" column="NOTIFICATION_TYPE"
                typeHandler="org.apache.ibatis.type.EnumTypeHandler"/>
        <result property="referenceType" column="REFERENCE_TYPE"
                typeHandler="org.apache.ibatis.type.EnumTypeHandler"/>
        <result property="referenceId" column="REFERENCE_ID"/>
        <result property="message" column="MESSAGE"/>
        <result property="isRead" column="IS_READ"/>
        <result property="createdAt" column="CREATED_AT"/>
    </resultMap>

    <!-- 알림 생성 -->
    <insert id="insertNotification"
            parameterType="kr.or.kosa.backend.notification.domain.Notification"
            useGeneratedKeys="true"
            keyProperty="notificationId">
        INSERT INTO NOTIFICATION (
        RECIPIENT_ID,
        SENDER_ID,
        NOTIFICATION_TYPE,
        REFERENCE_TYPE,
        REFERENCE_ID,
        MESSAGE,
        IS_READ,
        CREATED_AT
        ) VALUES (
        #{recipientId},
        #{senderId},
        #{notificationType},
        #{referenceType},
        #{referenceId},
        #{message},
        FALSE,
        NOW()
        )
    </insert>

    <!-- 사용자의 읽지 않은 알림 조회 -->
    <select id="selectUnreadNotifications" resultMap="notificationResultMap">
        SELECT *
        FROM NOTIFICATION
        WHERE RECIPIENT_ID = #{recipientId}
        AND IS_READ = FALSE
        ORDER BY CREATED_AT DESC
    </select>

    <!-- 알림 읽음 처리 -->
    <update id="markAsRead">
        UPDATE NOTIFICATION
        SET IS_READ = TRUE
        WHERE NOTIFICATION_ID = #{notificationId}
    </update>

    <!-- 참조 대상의 모든 알림 삭제 -->
    <delete id="deleteByReference">
        DELETE FROM NOTIFICATION
        WHERE REFERENCE_TYPE = #{referenceType}
        AND REFERENCE_ID = #{referenceId}
    </delete>

</mapper>
