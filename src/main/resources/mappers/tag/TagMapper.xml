<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="kr.or.kosa.backend.tag.mapper.TagMapper">

    <!-- 태그명으로 조회 -->
    <select id="findByTagName" resultType="kr.or.kosa.backend.tag.domain.Tag">
        SELECT TAG_ID, TAG_NAME
        FROM TAG
        WHERE TAG_NAME = #{tagName}
    </select>

    <!-- 태그 저장 -->
    <insert id="insertTag" useGeneratedKeys="true" keyProperty="tagId">
        INSERT INTO TAG (TAG_NAME)
        VALUES (#{tagName})
    </insert>

    <!-- 태그 삭제 -->
    <delete id="deleteTag">
        DELETE FROM TAG
        WHERE TAG_ID = #{tagId}
    </delete>

    <!-- 태그명으로 시작하는 태그 검색 (자동완성) -->
    <select id="findByTagNameStartingWith" resultType="kr.or.kosa.backend.tag.domain.Tag">
        SELECT TAG_ID, TAG_NAME
        FROM TAG
        WHERE TAG_NAME LIKE CONCAT(#{keyword}, '%')
        ORDER BY TAG_NAME
    </select>

    <!-- 가장 많이 사용된 표기 찾기 -->
    <select id="findMostUsedDisplayName" resultType="string">
        SELECT TAG_DISPLAY_NAME
        FROM (
        SELECT TAG_DISPLAY_NAME, COUNT(*) as cnt
        FROM CODEBOARD_TAG
        WHERE TAG_ID = #{tagId}
        GROUP BY TAG_DISPLAY_NAME
        UNION ALL
        SELECT TAG_DISPLAY_NAME, COUNT(*) as cnt
        FROM FREEBOARD_TAG
        WHERE TAG_ID = #{tagId}
        GROUP BY TAG_DISPLAY_NAME
        ) combined
        GROUP BY TAG_DISPLAY_NAME
        ORDER BY SUM(cnt) DESC
        LIMIT 1
    </select>

    <!-- 태그 사용 횟수 -->
    <select id="countByTagId" resultType="long">
        SELECT COUNT(*)
        FROM (
        SELECT TAG_ID FROM CODEBOARD_TAG WHERE TAG_ID = #{tagId}
        UNION ALL
        SELECT TAG_ID FROM FREEBOARD_TAG WHERE TAG_ID = #{tagId}
        ) combined
    </select>

</mapper>