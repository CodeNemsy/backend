<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="kr.or.kosa.backend.comment.mapper.CommentMapper">

    <resultMap id="commentResultMap" type="kr.or.kosa.backend.comment.domain.Comment">
        <id property="commentId" column="comment_id"/>
        <result property="boardId" column="board_id"/>
        <result property="boardType" column="board_type"/>
        <result property="parentCommentId" column="parent_comment_id"/>
        <result property="userId" column="user_id"/>
        <result property="content" column="content"/>
        <result property="likeCount" column="like_count"/>
        <result property="isDeleted" column="is_deleted"/>
        <result property="createdAt" column="created_at"/>
        <result property="updatedAt" column="updated_at"/>
    </resultMap>

    <!-- 댓글 생성 -->
    <insert id="insertComment"
            parameterType="kr.or.kosa.backend.comment.domain.Comment"
            useGeneratedKeys="true"
            keyProperty="commentId">
        INSERT INTO `comment` (
        board_id,
        board_type,
        parent_comment_id,
        user_id,
        content,
        like_count,
        is_deleted,
        created_at,
        updated_at
        ) VALUES (
        #{boardId},
        #{boardType},
        #{parentCommentId},
        #{userId},
        #{content},
        0,
        FALSE,
        NOW(),
        NOW()
        )
    </insert>

    <!-- 댓글 단건 조회 -->
    <select id="selectCommentById" resultMap="commentResultMap">
        SELECT
        comment_id,
        board_id,
        board_type,
        parent_comment_id,
        user_id,
        content,
        like_count,
        is_deleted,
        created_at,
        updated_at
        FROM `comment`
        WHERE comment_id = #{commentId}
    </select>

    <!-- 게시글의 댓글 목록 조회 -->
    <select id="selectCommentsByBoard" resultMap="commentResultMap">
        SELECT
        comment_id,
        board_id,
        board_type,
        parent_comment_id,
        user_id,
        content,
        like_count,
        is_deleted,
        created_at,
        updated_at
        FROM `comment`
        WHERE board_id = #{boardId}
        AND board_type = #{boardType}
        AND parent_comment_id IS NULL
        AND is_deleted = FALSE
        ORDER BY created_at ASC
    </select>

    <!-- 대댓글 목록 조회 -->
    <select id="selectRepliesByParentIds" resultMap="commentResultMap">
        SELECT
        comment_id,
        board_id,
        board_type,
        parent_comment_id,
        user_id,
        content,
        like_count,
        is_deleted,
        created_at,
        updated_at
        FROM `comment`
        WHERE parent_comment_id IN
        <foreach collection="parentCommentIds"
                 item="parentId"
                 open="("
                 separator=","
                 close=")">
            #{parentId}
        </foreach>
        AND is_deleted = FALSE
        ORDER BY created_at ASC
    </select>

    <!-- 댓글 수정 -->
    <update id="updateComment"
            parameterType="kr.or.kosa.backend.comment.domain.Comment">
        UPDATE `comment`
        SET content   = #{content},
        updated_at = NOW()
        WHERE comment_id = #{commentId}
    </update>

    <!-- 댓글 소프트 삭제 -->
    <update id="deleteComment">
        UPDATE `comment`
        SET is_deleted = TRUE,
        updated_at = NOW()
        WHERE comment_id = #{commentId}
    </update>

    <!-- 좋아요 개수 증가 -->
    <update id="incrementLikeCount">
        UPDATE `comment`
        SET like_count = like_count + 1
        WHERE comment_id = #{commentId}
    </update>

    <!-- 좋아요 개수 감소 -->
    <update id="decrementLikeCount">
        UPDATE `comment`
        SET like_count = like_count - 1
        WHERE comment_id = #{commentId}
        AND like_count > 0
    </update>

    <!-- 특정 사용자의 댓글인지 확인 -->
    <select id="existsByCommentIdAndUserId" resultType="boolean">
        SELECT EXISTS(
        SELECT 1
        FROM `comment`
        WHERE comment_id = #{commentId}
        AND user_id = #{userId}
        )
    </select>

</mapper>
