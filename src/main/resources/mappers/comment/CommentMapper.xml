<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="kr.or.kosa.backend.comment.mapper.CommentMapper">

    <resultMap id="commentResultMap" type="kr.or.kosa.backend.comment.domain.Comment">
        <id property="commentId" column="COMMENT_ID"/>
        <result property="boardId" column="BOARD_ID"/>
        <result property="boardType" column="BOARD_TYPE"/>
        <result property="parentCommentId" column="PARENT_COMMENT_ID"/>
        <result property="userId" column="USER_ID"/>
        <result property="content" column="CONTENT"/>
        <result property="likeCount" column="LIKE_COUNT"/>
        <result property="isDeleted" column="IS_DELETED"/>
        <result property="createdAt" column="CREATED_AT"/>
        <result property="updatedAt" column="UPDATED_AT"/>
    </resultMap>

    <!-- 댓글 생성 -->
    <insert id="insertComment"
            parameterType="kr.or.kosa.backend.comment.domain.Comment"
            useGeneratedKeys="true"
            keyProperty="commentId">
        INSERT INTO COMMENT (
        BOARD_ID,
        BOARD_TYPE,
        PARENT_COMMENT_ID,
        USER_ID,
        CONTENT,
        LIKE_COUNT,
        IS_DELETED,
        CREATED_AT,
        UPDATED_AT
        ) VALUES (
        #{boardId},
        #{boardType},
        #{parentCommentId},
        #{userId},
        #{content},
        0,
        FALSE,
        NOW(),
        NOW()
        )
    </insert>

    <!-- 댓글 단건 조회 -->
    <select id="selectCommentById" resultMap="commentResultMap">
        SELECT
        COMMENT_ID,
        BOARD_ID,
        BOARD_TYPE,
        PARENT_COMMENT_ID,
        USER_ID,
        CONTENT,
        LIKE_COUNT,
        IS_DELETED,
        CREATED_AT,
        UPDATED_AT
        FROM COMMENT
        WHERE COMMENT_ID = #{commentId}
    </select>

    <!-- 게시글의 댓글 목록 조회 -->
    <select id="selectCommentsByBoard" resultMap="commentResultMap">
        SELECT
        COMMENT_ID,
        BOARD_ID,
        BOARD_TYPE,
        PARENT_COMMENT_ID,
        USER_ID,
        CONTENT,
        LIKE_COUNT,
        IS_DELETED,
        CREATED_AT,
        UPDATED_AT
        FROM COMMENT
        WHERE BOARD_ID = #{boardId}
        AND BOARD_TYPE = #{boardType}
        AND PARENT_COMMENT_ID IS NULL
        AND IS_DELETED = FALSE
        ORDER BY CREATED_AT ASC
    </select>

    <!-- 대댓글 목록 조회 -->
    <select id="selectRepliesByParentIds" resultMap="commentResultMap">
        SELECT
        COMMENT_ID,
        BOARD_ID,
        BOARD_TYPE,
        PARENT_COMMENT_ID,
        USER_ID,
        CONTENT,
        LIKE_COUNT,
        IS_DELETED,
        CREATED_AT,
        UPDATED_AT
        FROM COMMENT
        WHERE PARENT_COMMENT_ID IN
        <foreach collection="parentCommentIds"
                 item="parentId"
                 open="("
                 separator=","
                 close=")">
            #{parentId}
        </foreach>
        AND IS_DELETED = FALSE
        ORDER BY CREATED_AT ASC
    </select>

    <!-- 댓글 수정 -->
    <update id="updateComment"
            parameterType="kr.or.kosa.backend.comment.domain.Comment">
        UPDATE COMMENT
        SET CONTENT   = #{content},
        UPDATED_AT = NOW()
        WHERE COMMENT_ID = #{commentId}
    </update>

    <!-- 댓글 소프트 삭제 -->
    <update id="deleteComment">
        UPDATE COMMENT
        SET IS_DELETED = TRUE,
        UPDATED_AT = NOW()
        WHERE COMMENT_ID = #{commentId}
    </update>

    <!-- 좋아요 개수 증가 -->
    <update id="incrementLikeCount">
        UPDATE COMMENT
        SET LIKE_COUNT = LIKE_COUNT + 1
        WHERE COMMENT_ID = #{commentId}
    </update>

    <!-- 좋아요 개수 감소 -->
    <update id="decrementLikeCount">
        UPDATE COMMENT
        SET LIKE_COUNT = LIKE_COUNT - 1
        WHERE COMMENT_ID = #{commentId}
        AND LIKE_COUNT > 0
    </update>

    <!-- 특정 사용자의 댓글인지 확인 -->
    <select id="existsByCommentIdAndUserId" resultType="boolean">
        SELECT EXISTS(
        SELECT 1
        FROM COMMENT
        WHERE COMMENT_ID = #{commentId}
        AND USER_ID = #{userId}
        )
    </select>

</mapper>
