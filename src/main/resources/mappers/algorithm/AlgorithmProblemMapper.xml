<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="kr.or.kosa.backend.algorithm.mapper.AlgorithmProblemMapper">

    <!-- ResultMap 정의 -->
    <resultMap id="AlgoProblemResultMap" type="kr.or.kosa.backend.algorithm.dto.AlgoProblemDto">
        <id property="algoProblemId" column="ALGO_PROBLEM_ID"/>
        <result property="algoProblemTitle" column="ALGO_PROBLEM_TITLE"/>
        <result property="algoProblemDescription" column="ALGO_PROBLEM_DESCRIPTION"/>
        <result property="algoProblemDifficulty" column="ALGO_PROBLEM_DIFFICULTY"
                typeHandler="org.apache.ibatis.type.EnumTypeHandler"/>
        <result property="algoProblemSource" column="ALGO_PROBLEM_SOURCE"
                typeHandler="org.apache.ibatis.type.EnumTypeHandler"/>
        <result property="problemType" column="PROBLEM_TYPE"
                typeHandler="org.apache.ibatis.type.EnumTypeHandler"/>
        <result property="initScript" column="INIT_SCRIPT"/>
        <result property="timelimit" column="TIMELIMIT"/>
        <result property="memorylimit" column="MEMORYLIMIT"/>
        <result property="algoCreater" column="ALGO_CREATER"/>
        <result property="algoCreatedAt" column="ALGO_CREATED_AT"/>
        <result property="algoUpdatedAt" column="ALGO_UPDATED_AT"/>
        <result property="algoProblemTags" column="ALGO_PROBLEM_TAGS"/>
        <result property="algoProblemStatus" column="ALGO_PROBLEM_STATUS"/>
        <result property="constraints" column="CONSTRAINTS"/>
        <result property="inputFormat" column="INPUT_FORMAT"/>
        <result property="outputFormat" column="OUTPUT_FORMAT"/>
    </resultMap>

    <!-- 기본 컬럼 정의 -->
    <sql id="problemColumns">
        ALGO_PROBLEM_ID,
        ALGO_PROBLEM_TITLE,
        ALGO_PROBLEM_DESCRIPTION,
        ALGO_PROBLEM_DIFFICULTY,
        ALGO_PROBLEM_SOURCE,
        PROBLEM_TYPE,
        INIT_SCRIPT,
        TIMELIMIT,
        MEMORYLIMIT,
        ALGO_CREATER,
        ALGO_CREATED_AT,
        ALGO_UPDATED_AT,
        ALGO_PROBLEM_TAGS,
        ALGO_PROBLEM_STATUS,
        CONSTRAINTS,
        INPUT_FORMAT,
        OUTPUT_FORMAT
    </sql>

    <!-- 전체 문제 목록 조회 (페이징) -->
    <select id="selectProblems" resultMap="AlgoProblemResultMap">
        SELECT
        <include refid="problemColumns"/>
        FROM ALGO_PROBLEMS
        WHERE ALGO_PROBLEM_STATUS = 1
        ORDER BY ALGO_CREATED_AT DESC
        LIMIT #{limit} OFFSET #{offset}
    </select>

    <!-- 전체 문제 수 조회 -->
    <select id="countAllProblems" resultType="int">
        SELECT COUNT(*)
        FROM ALGO_PROBLEMS
        WHERE ALGO_PROBLEM_STATUS = 1
    </select>

    <!-- 문제 목록 조회 (필터 포함) -->
    <select id="selectProblemsWithFilter" resultMap="AlgoProblemResultMap">
        SELECT
        <include refid="problemColumns"/>
        FROM ALGO_PROBLEMS
        WHERE ALGO_PROBLEM_STATUS = 1
        <if test="difficulty != null and difficulty != ''">
            AND ALGO_PROBLEM_DIFFICULTY = #{difficulty}
        </if>
        <if test="source != null and source != ''">
            AND ALGO_PROBLEM_SOURCE = #{source}
        </if>
        <if test="problemType != null and problemType != ''">
            AND PROBLEM_TYPE = #{problemType}
        </if>
        <if test="keyword != null and keyword != ''">
            AND (ALGO_PROBLEM_TITLE LIKE CONCAT('%', #{keyword}, '%')
            OR ALGO_PROBLEM_DESCRIPTION LIKE CONCAT('%', #{keyword}, '%'))
        </if>
        ORDER BY ALGO_CREATED_AT DESC
        LIMIT #{limit} OFFSET #{offset}
    </select>

    <!-- 전체 문제 수 조회 (필터 포함) -->
    <select id="countProblemsWithFilter" resultType="int">
        SELECT COUNT(*)
        FROM ALGO_PROBLEMS
        WHERE ALGO_PROBLEM_STATUS = 1
        <if test="difficulty != null and difficulty != ''">
            AND ALGO_PROBLEM_DIFFICULTY = #{difficulty}
        </if>
        <if test="source != null and source != ''">
            AND ALGO_PROBLEM_SOURCE = #{source}
        </if>
        <if test="problemType != null and problemType != ''">
            AND PROBLEM_TYPE = #{problemType}
        </if>
        <if test="keyword != null and keyword != ''">
            AND (ALGO_PROBLEM_TITLE LIKE CONCAT('%', #{keyword}, '%')
            OR ALGO_PROBLEM_DESCRIPTION LIKE CONCAT('%', #{keyword}, '%'))
        </if>
    </select>

    <!-- 문제 상세 조회 -->
    <select id="selectProblemById" resultMap="AlgoProblemResultMap">
        SELECT
        <include refid="problemColumns"/>
        FROM ALGO_PROBLEMS
        WHERE ALGO_PROBLEM_ID = #{problemId}
        AND ALGO_PROBLEM_STATUS = 1
    </select>

    <!-- 문제 존재 여부 확인 -->
    <select id="existsProblemById" resultType="boolean">
        SELECT COUNT(*) > 0
        FROM ALGO_PROBLEMS
        WHERE ALGO_PROBLEM_ID = #{problemId}
        AND ALGO_PROBLEM_STATUS = 1
    </select>

    <!-- AI 생성 문제 저장 -->
    <insert id="insertProblem"
            parameterType="kr.or.kosa.backend.algorithm.dto.AlgoProblemDto"
            useGeneratedKeys="true"
            keyProperty="algoProblemId"
            keyColumn="ALGO_PROBLEM_ID">
        INSERT INTO ALGO_PROBLEMS (
        ALGO_PROBLEM_TITLE, ALGO_PROBLEM_DESCRIPTION, ALGO_PROBLEM_DIFFICULTY, ALGO_PROBLEM_SOURCE,
        PROBLEM_TYPE, INIT_SCRIPT, TIMELIMIT, MEMORYLIMIT, ALGO_CREATER,
        ALGO_CREATED_AT, ALGO_UPDATED_AT, ALGO_PROBLEM_TAGS, ALGO_PROBLEM_STATUS,
        CONSTRAINTS, INPUT_FORMAT, OUTPUT_FORMAT
        ) VALUES (
        #{algoProblemTitle}, #{algoProblemDescription}, #{algoProblemDifficulty}, #{algoProblemSource},
        #{problemType,typeHandler=org.apache.ibatis.type.EnumTypeHandler}, #{initScript}, #{timelimit}, #{memorylimit}, #{algoCreater},
        #{algoCreatedAt}, #{algoUpdatedAt}, #{algoProblemTags}, #{algoProblemStatus},
        #{constraints}, #{inputFormat}, #{outputFormat}
        )
    </insert>

    <!-- 테스트케이스 저장 -->
    <insert id="insertTestcase"
            parameterType="kr.or.kosa.backend.algorithm.dto.AlgoTestcaseDto"
            useGeneratedKeys="true"
            keyProperty="testcaseId"
            keyColumn="TESTCASE_ID">
        INSERT INTO ALGO_TESTCASES (
        ALGO_PROBLEM_ID, INPUT_DATA, EXPECTED_OUTPUT, IS_SAMPLE
        ) VALUES (
        #{algoProblemId}, #{inputData}, #{expectedOutput}, #{isSample}
        )
    </insert>

    <!-- 샘플 테스트케이스 조회 -->
    <select id="selectSampleTestCasesByProblemId" resultMap="algoTestcaseResultMap">
        SELECT TESTCASE_ID, ALGO_PROBLEM_ID, INPUT_DATA, EXPECTED_OUTPUT, IS_SAMPLE
        FROM ALGO_TESTCASES
        WHERE ALGO_PROBLEM_ID = #{problemId}
        AND IS_SAMPLE = 1
        ORDER BY TESTCASE_ID ASC
    </select>

    <!-- 모든 테스트케이스 조회 -->
    <select id="selectTestCasesByProblemId" resultMap="algoTestcaseResultMap">
        SELECT TESTCASE_ID, ALGO_PROBLEM_ID, INPUT_DATA, EXPECTED_OUTPUT, IS_SAMPLE
        FROM ALGO_TESTCASES
        WHERE ALGO_PROBLEM_ID = #{problemId}
        ORDER BY TESTCASE_ID ASC
    </select>

    <!-- algoTestcaseResultMap -->
    <resultMap id="algoTestcaseResultMap" type="kr.or.kosa.backend.algorithm.dto.AlgoTestcaseDto">
        <id property="testcaseId" column="TESTCASE_ID"/>
        <result property="algoProblemId" column="ALGO_PROBLEM_ID"/>
        <result property="inputData" column="INPUT_DATA"/>
        <result property="expectedOutput" column="EXPECTED_OUTPUT"/>
        <result property="isSample" column="IS_SAMPLE"/>
    </resultMap>

    <!-- 문제별 통계 조회 (제출 수, 맞힌 사람 수) -->
    <select id="selectProblemStatistics" resultType="map">
        SELECT
            COALESCE(COUNT(*), 0) AS totalAttempts,
            COALESCE(COUNT(DISTINCT CASE WHEN JUDGE_RESULT = 'AC' THEN USER_ID END), 0) AS successCount
        FROM ALGO_SUBMISSIONS
        WHERE ALGO_PROBLEM_ID = #{problemId}
    </select>

    <!-- 사용자 풀이 상태 포함 문제 목록 조회 -->
    <select id="selectProblemsWithUserStatus" resultType="map">
        SELECT
        p.ALGO_PROBLEM_ID as algoProblemId,
        p.ALGO_PROBLEM_TITLE as algoProblemTitle,
        p.ALGO_PROBLEM_DIFFICULTY as algoProblemDifficulty,
        p.ALGO_PROBLEM_TAGS as algoProblemTags,
        p.ALGO_PROBLEM_SOURCE as algoProblemSource,
        p.PROBLEM_TYPE as problemType,
        p.ALGO_CREATER as algoCreater,
        CASE
        WHEN #{userId} IS NOT NULL AND EXISTS (
        SELECT 1 FROM ALGO_SUBMISSIONS s
        WHERE s.USER_ID = #{userId}
        AND s.ALGO_PROBLEM_ID = p.ALGO_PROBLEM_ID
        AND s.JUDGE_RESULT = 'AC'
        ) THEN true
        ELSE false
        END AS isSolved
        FROM ALGO_PROBLEMS p
        WHERE p.ALGO_PROBLEM_STATUS = 1
        <if test="difficulty != null and difficulty != ''">
            AND p.ALGO_PROBLEM_DIFFICULTY = #{difficulty}
        </if>
        <if test="tags != null and tags != ''">
            AND p.ALGO_PROBLEM_TAGS LIKE CONCAT('%', #{tags}, '%')
        </if>
        ORDER BY p.ALGO_PROBLEM_ID ASC
        LIMIT #{size} OFFSET #{offset}
    </select>

</mapper>