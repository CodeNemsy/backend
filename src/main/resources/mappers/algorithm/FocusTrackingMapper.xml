<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="kr.or.kosa.backend.algorithm.mapper.FocusTrackingMapper">

    <!-- 세션 시작 -->
    <insert id="startSession" parameterType="kr.or.kosa.backend.algorithm.dto.FocusSessionDto">
        INSERT INTO focus_sessions (
            session_id,
            user_id,
            algo_problem_id,
            started_at,
            session_status,
            violation_count
        ) VALUES (
            #{sessionId},
            #{userId},
            #{problemId},
            #{startTime},
            'ACTIVE',
            0
        )
    </insert>

    <!-- 세션 종료 업데이트 -->
    <update id="updateSession" parameterType="kr.or.kosa.backend.algorithm.dto.FocusSessionDto">
        UPDATE focus_sessions
        SET
            ended_at = #{endTime},
            session_status = #{status},
            violation_count = #{violationCount}
        WHERE session_id = #{sessionId}
    </update>

    <!-- 위반 로그 저장 -->
    <insert id="insertViolationLog" parameterType="kr.or.kosa.backend.algorithm.dto.ViolationLogDto" useGeneratedKeys="true" keyProperty="violationId">
        INSERT INTO violation_logs (
            session_id,
            user_id,
            violation_type,
            severity,
            occurrence_count,
            auto_action,
            penalty_score,
            detected_at,
            session_time_offset_seconds
        ) VALUES (
            #{sessionId},
            #{userId},
            #{violationType},
            #{severity},
            #{occurrenceCount},
            #{autoAction},
            #{penaltyScore},
            NOW(),
            #{sessionTimeOffsetSeconds}
        )
    </insert>

    <!-- 집중도 요약 저장 -->
    <insert id="insertFocusSummary" parameterType="kr.or.kosa.backend.algorithm.dto.FocusSummaryDto">
        INSERT INTO focus_summary (
            session_id,
            user_id,
            total_events,
            focus_in_percentage,
            total_violations,
            final_focus_score,
            focus_grade,
            processed_at
        ) VALUES (
            #{sessionId},
            #{userId},
            #{totalEvents},
            #{focusInPercentage},
            #{totalViolations},
            #{finalFocusScore},
            #{focusGrade},
            NOW()
        )
    </insert>

    <!-- 세션 조회 -->
    <select id="findSessionById" resultType="kr.or.kosa.backend.algorithm.dto.FocusSessionDto">
        SELECT
            session_id as sessionId,
            user_id as userId,
            algo_problem_id as problemId,
            started_at as startTime,
            ended_at as endTime,
            session_status as status,
            violation_count as violationCount
        FROM focus_sessions
        WHERE session_id = #{sessionId}
    </select>

    <!-- 위반 로그 목록 조회 -->
    <select id="findLogsBySessionId" resultType="kr.or.kosa.backend.algorithm.dto.ViolationLogDto">
        SELECT
            violation_id as violationId,
            session_id as sessionId,
            user_id as userId,
            violation_type as violationType,
            severity,
            occurrence_count as occurrenceCount,
            auto_action as autoAction,
            penalty_score as penaltyScore,
            detected_at as detectedAt,
            session_time_offset_seconds as sessionTimeOffsetSeconds
        FROM violation_logs
        WHERE session_id = #{sessionId}
        ORDER BY detected_at ASC
    </select>

    <!-- 활성 세션 조회 -->
    <select id="findActiveSessionByUserId" resultType="kr.or.kosa.backend.algorithm.dto.FocusSessionDto">
        SELECT
            session_id as sessionId,
            user_id as userId,
            algo_problem_id as problemId,
            started_at as startTime,
            session_status as status
        FROM focus_sessions
        WHERE user_id = #{userId}
        AND algo_problem_id = #{problemId}
        AND session_status = 'ACTIVE'
        LIMIT 1
    </select>

</mapper>
